<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>个人博客</title>
  <subtitle>身体和灵魂，总有一个在路上</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2017-08-07T15:53:58.346Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>kumu</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ELK环境搭建</title>
    <link href="http://yoursite.com/2017/08/04/ELK/"/>
    <id>http://yoursite.com/2017/08/04/ELK/</id>
    <published>2017-08-04T15:05:00.000Z</published>
    <updated>2017-08-07T15:53:58.346Z</updated>
    
    <content type="html"><![CDATA[<h4 id="一、配置"><a href="#一、配置" class="headerlink" title="一、配置"></a>一、配置</h4><pre><code>系统： Windows 8.1
elasticsearch：5.5.1
logstash：2.0.0
kibana：5.5.1
</code></pre><blockquote>
<p>注：由于实验性搭建，选择windows系统，但选择Linux系统效果更佳</p>
</blockquote>
<h4 id="二、部署方案"><a href="#二、部署方案" class="headerlink" title="二、部署方案"></a>二、部署方案</h4><h5 id="1-ELK-Redis"><a href="#1-ELK-Redis" class="headerlink" title="1.ELK+Redis"></a>1.ELK+Redis</h5><h5 id="2-ELK-Kafka"><a href="#2-ELK-Kafka" class="headerlink" title="2.ELK+Kafka"></a>2.ELK+Kafka</h5><blockquote>
<p>注：本次搭建选用第一种方案<br><a id="more"></a></p>
</blockquote>
<h4 id="三、安装"><a href="#三、安装" class="headerlink" title="三、安装"></a>三、安装</h4><blockquote>
<p>前提:<a href="https://nssm.cc/release/nssm-2.24.zip" target="_blank" rel="external">下载nssm</a></p>
</blockquote>
<h5 id="1-Elasticsearch"><a href="#1-Elasticsearch" class="headerlink" title="1. Elasticsearch"></a>1. Elasticsearch</h5><h6 id="下载：-download"><a href="#下载：-download" class="headerlink" title="下载： download"></a>下载： <a href="https://www.elastic.co/downloads/elasticsearch" target="_blank" rel="external">download</a></h6><h5 id="2-logstash"><a href="#2-logstash" class="headerlink" title="2. logstash"></a>2. logstash</h5><h6 id="下载：-download-1"><a href="#下载：-download-1" class="headerlink" title="下载： download"></a>下载： <a href="https://www.elastic.co/downloads/logstash" target="_blank" rel="external">download</a></h6><h5 id="3-kibana"><a href="#3-kibana" class="headerlink" title="3. kibana"></a>3. kibana</h5><h6 id="下载：-download-2"><a href="#下载：-download-2" class="headerlink" title="下载： download"></a>下载： <a href="https://www.elastic.co/downloads/kibana" target="_blank" rel="external">download</a></h6><h5 id="注册为windows服务"><a href="#注册为windows服务" class="headerlink" title="注册为windows服务"></a>注册为windows服务</h5><h6 id="a-将下载的nssm-exe分别拷贝到Elasticsearch、logstash和kibana解压后的bin目录下，然后CMD进入bin执行nssm-install-服务名-例如Elasticsearch-的执行nssm-install-elasticsearch-service"><a href="#a-将下载的nssm-exe分别拷贝到Elasticsearch、logstash和kibana解压后的bin目录下，然后CMD进入bin执行nssm-install-服务名-例如Elasticsearch-的执行nssm-install-elasticsearch-service" class="headerlink" title="(a) 将下载的nssm.exe分别拷贝到Elasticsearch、logstash和kibana解压后的bin目录下，然后CMD进入bin执行nssm install 服务名,例如Elasticsearch 的执行nssm install elasticsearch-service.."></a>(a) 将下载的nssm.exe分别拷贝到Elasticsearch、logstash和kibana解压后的bin目录下，然后CMD进入bin执行nssm install 服务名,例如Elasticsearch 的执行nssm install elasticsearch-service..<br></h6><h6 id="b-分析选择path为各压缩包的bin目录下的elasticsearch-bat、logstash-bat和kibana-bat"><a href="#b-分析选择path为各压缩包的bin目录下的elasticsearch-bat、logstash-bat和kibana-bat" class="headerlink" title="(b) 分析选择path为各压缩包的bin目录下的elasticsearch.bat、logstash.bat和kibana.bat"></a>(b) 分析选择path为各压缩包的bin目录下的elasticsearch.bat、logstash.bat和kibana.bat</h6><h6 id="c-Details选项卡设置显示名为Windows名"><a href="#c-Details选项卡设置显示名为Windows名" class="headerlink" title="(c) Details选项卡设置显示名为Windows名"></a>(c) Details选项卡设置显示名为Windows名</h6><h6 id="d-最后选择Install-service"><a href="#d-最后选择Install-service" class="headerlink" title="(d) 最后选择Install service"></a>(d) 最后选择Install service</h6><h4 id="四、部署"><a href="#四、部署" class="headerlink" title="四、部署"></a>四、部署</h4><h5 id="1-创建Maven项目elk-log-可另外取名-，pom文件为："><a href="#1-创建Maven项目elk-log-可另外取名-，pom文件为：" class="headerlink" title="1. 创建Maven项目elk-log(可另外取名)，pom文件为："></a>1. 创建Maven项目elk-log(可另外取名)，pom文件为：</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</div><div class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.suncj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elk-log<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>elk-log<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">description</span>&gt;</span>elk日志生成项目<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.jetty.aggregate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jetty-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>8.1.19.v20160209<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.logstash.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logstash-logback-encoder<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>4.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="comment">&lt;!--实现slf4j接口并整合 --&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<h5 id="2-配置logback-logback-xml文件为："><a href="#2-配置logback-logback-xml文件为：" class="headerlink" title="2. 配置logback,logback.xml文件为："></a>2. 配置logback,logback.xml文件为：</h5><figure class="highlight dust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span></div><div class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">debug</span>=<span class="string">"false"</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"console"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.encoder.PatternLayoutEncoder"</span>&gt;</span></div><div class="line">			<span class="comment">&lt;!-- 格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符 --&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d<span class="template-variable">&#123;HH:mm:ss.SSS&#125;</span><span class="xml"> [%thread] %-5level %c</span><span class="template-variable">&#123;1&#125;</span><span class="xml">.%M:%L - %m%n</span></div><div class="line">			<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">appender</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"stash"</span></span></div><div class="line">		<span class="attr">class</span>=<span class="string">"net.logstash.logback.appender.LogstashTcpSocketAppender"</span>&gt;</div><div class="line">		<span class="tag">&lt;<span class="name">destination</span>&gt;</span>127.0.0.1:9250<span class="tag">&lt;/<span class="name">destination</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span></span></div><div class="line">			<span class="attr">class</span>=<span class="string">"net.logstash.logback.encoder.LogstashEncoder"</span> /&gt;</div><div class="line">	<span class="tag">&lt;/<span class="name">appender</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.suncj"</span> <span class="attr">level</span>=<span class="string">"INFO"</span> /&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"INFO"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"console"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"stash"</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">root</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure>
<h5 id="3-设置项目定时任务-打日志"><a href="#3-设置项目定时任务-打日志" class="headerlink" title="3.设置项目定时任务(打日志)"></a>3.设置项目定时任务(打日志)</h5><p>定时任务类LogProducer:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">package com.suncj.elk;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Random;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 日志生成器&lt;br&gt;</div><div class="line"> * 版权：Copyright (c) 2015-2016&lt;br&gt;</div><div class="line"> * 创建日期：2017年8月5日&lt;br&gt;</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogProducer</span> &#123;</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> final Logger <span class="built_in">log</span> = LoggerFactory.getLogger(LogProducer.class);</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Random rand = <span class="keyword">new</span> Random();</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> logId = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="built_in">log</span>.info(<span class="string">"log_id: &#123;&#125; , content:&#123;&#125;"</span>, logId, String.format(<span class="string">"I am %s"</span>, logId + rand.nextInt(<span class="number">100000</span>)));</div><div class="line">		logId++;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>项目启动类:<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">package com.suncj.elk;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</div><div class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> logger = <span class="type">LoggerFactory</span>.getLogger(<span class="type">Application</span>.<span class="keyword">class</span>);</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">ApplicationContext</span> appContext;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> void main(<span class="type">String</span>[] args) &#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			logger.info(<span class="string">"准备加载程序"</span>);</div><div class="line">			appContext = new <span class="type">ClassPathXmlApplicationContext</span>(<span class="string">"app-*.xml"</span>);</div><div class="line">			logger.info(<span class="string">"加载完成"</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (<span class="type">Exception</span> e) &#123;</div><div class="line">			logger.error(<span class="string">"主程序出错:"</span>, e);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其他配置文件：app-task.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">	<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:util</span>=<span class="string">"http://www.springframework.org/schema/util"</span></div><div class="line">	<span class="attr">xmlns:task</span>=<span class="string">"http://www.springframework.org/schema/task"</span> <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></div><div class="line">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd</span></div><div class="line">		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">		http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd</div><div class="line">		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd"&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"logProducer"</span> <span class="attr">class</span>=<span class="string">"com.suncj.elk.LogProducer"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">task:scheduled-tasks</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">task:scheduled</span> <span class="attr">ref</span>=<span class="string">"logProducer"</span> <span class="attr">method</span>=<span class="string">"produce"</span></span></div><div class="line">			<span class="attr">cron</span>=<span class="string">"0/5 * * * * *"</span> /&gt;</div><div class="line">	<span class="tag">&lt;/<span class="name">task:scheduled-tasks</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h5 id="2-logstash配置"><a href="#2-logstash配置" class="headerlink" title="2. logstash配置"></a>2. logstash配置</h5><h6 id="a-run-es-bat，run-redis-bat"><a href="#a-run-es-bat，run-redis-bat" class="headerlink" title="(a) run_es.bat，run_redis.bat"></a>(a) run_es.bat，run_redis.bat</h6><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">logstash</span><span class="selector-class">.bat</span> <span class="selector-tag">agent</span> <span class="selector-tag">-f</span> <span class="selector-tag">logstash_es</span><span class="selector-class">.conf</span></div></pre></td></tr></table></figure>
<h6 id="b-logstash-redis-conf"><a href="#b-logstash-redis-conf" class="headerlink" title="(b) logstash_redis.conf"></a>(b) logstash_redis.conf</h6><figure class="highlight puppet"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">input</span> &#123;</div><div class="line">	tcp &#123;</div><div class="line">		<span class="attr">host</span> =&gt; <span class="string">"127.0.0.1"</span></div><div class="line">		<span class="attr">port</span> =&gt; <span class="number">9250</span></div><div class="line">		<span class="attr">mode</span> =&gt; <span class="string">"server"</span></div><div class="line">		<span class="attr">codec</span> =&gt; json_lines</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">output</span> &#123;</div><div class="line">	redis &#123;</div><div class="line">		<span class="attr">host</span> =&gt; <span class="string">"127.0.0.1"</span></div><div class="line">        <span class="attr">port</span> =&gt; <span class="number">6379</span></div><div class="line">        <span class="attr">db</span> =&gt; <span class="number">1</span></div><div class="line">		<span class="attr">data_type</span> =&gt; <span class="string">"list"</span></div><div class="line">		<span class="attr">key</span> =&gt; <span class="string">"log:es"</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h6 id="c-logstash-es-conf"><a href="#c-logstash-es-conf" class="headerlink" title="(c) logstash_es.conf"></a>(c) logstash_es.conf</h6><figure class="highlight puppet"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">input</span> &#123;</div><div class="line">  redis &#123;</div><div class="line">    <span class="attr">data_type</span> =&gt; <span class="string">"list"</span></div><div class="line">    <span class="attr">key</span> =&gt; <span class="string">"log:es"</span></div><div class="line">    <span class="attr">host</span> =&gt; <span class="string">"127.0.0.1"</span></div><div class="line">    <span class="attr">db</span> =&gt; <span class="number">1</span></div><div class="line">    <span class="attr">port</span> =&gt; <span class="number">6379</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">output</span> &#123;</div><div class="line">  stdout&#123;</div><div class="line">    <span class="attr">codec</span> =&gt; rubydebug</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">elasticsearch</span> &#123;</div><div class="line">    <span class="attr">hosts</span> =&gt; [<span class="string">"127.0.0.1:9200"</span>]</div><div class="line">    <span class="attr">index</span> =&gt; <span class="string">"log-es-%&#123;+YYYY.MM.dd&#125;"</span></div><div class="line">    <span class="attr">flush_size</span> =&gt; <span class="number">1000</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>注: logstash注册为windows服务时需要<br>创建两个bat文件，一个用于项目日志存储到redis；另外一个用户读取redis,输出到elasticsearch，因此需要注册两个服务名不同的windows服务</p>
</blockquote>
<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><p><a href="https://kibana.logstash.es/content/kibana/index.html" target="_blank" rel="external">https://kibana.logstash.es/content/kibana/index.html</a></p>
<p><a href="http://blog.csdn.net/tulizi/article/details/52972824" target="_blank" rel="external">http://blog.csdn.net/tulizi/article/details/52972824</a></p>
<p><a href="http://udn.yyuap.com/doc/logstash-best-practice-cn/input/redis.html" target="_blank" rel="external">http://udn.yyuap.com/doc/logstash-best-practice-cn/input/redis.html</a></p>
<p><a href="https://www.elastic.co/guide/en/logstash/current/codec-plugins.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/current/codec-plugins.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;一、配置&quot;&gt;&lt;a href=&quot;#一、配置&quot; class=&quot;headerlink&quot; title=&quot;一、配置&quot;&gt;&lt;/a&gt;一、配置&lt;/h4&gt;&lt;pre&gt;&lt;code&gt;系统： Windows 8.1
elasticsearch：5.5.1
logstash：2.0.0
kibana：5.5.1
&lt;/code&gt;&lt;/pre&gt;&lt;blockquote&gt;
&lt;p&gt;注：由于实验性搭建，选择windows系统，但选择Linux系统效果更佳&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;二、部署方案&quot;&gt;&lt;a href=&quot;#二、部署方案&quot; class=&quot;headerlink&quot; title=&quot;二、部署方案&quot;&gt;&lt;/a&gt;二、部署方案&lt;/h4&gt;&lt;h5 id=&quot;1-ELK-Redis&quot;&gt;&lt;a href=&quot;#1-ELK-Redis&quot; class=&quot;headerlink&quot; title=&quot;1.ELK+Redis&quot;&gt;&lt;/a&gt;1.ELK+Redis&lt;/h5&gt;&lt;h5 id=&quot;2-ELK-Kafka&quot;&gt;&lt;a href=&quot;#2-ELK-Kafka&quot; class=&quot;headerlink&quot; title=&quot;2.ELK+Kafka&quot;&gt;&lt;/a&gt;2.ELK+Kafka&lt;/h5&gt;&lt;blockquote&gt;
&lt;p&gt;注：本次搭建选用第一种方案&lt;br&gt;
    
    </summary>
    
      <category term="ELK" scheme="http://yoursite.com/categories/ELK/"/>
    
    
      <category term="ELK" scheme="http://yoursite.com/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>Spring-Shiro介绍及其使用</title>
    <link href="http://yoursite.com/2017/08/01/spring-shiro/"/>
    <id>http://yoursite.com/2017/08/01/spring-shiro/</id>
    <published>2017-08-01T03:17:11.000Z</published>
    <updated>2017-08-07T16:46:29.570Z</updated>
    
    <content type="html"><![CDATA[<h5 id="What-is-Apache-Shiro"><a href="#What-is-Apache-Shiro" class="headerlink" title="What is Apache Shiro?"></a>What is Apache Shiro?</h5><p>Apache Shiro是一个功能强大、灵活的，开源的安全框架。它可以干净利落地处理身份验证、授权、企业会话管理和加密。</p>

<p>Apache Shiro的首要目标是易于使用和理解。安全通常很复杂，甚至让人感到很痛苦，但是Shiro却不是这样子的。一个好的安全框架应该屏蔽复杂性，向外暴露简单、直观的API，来简化开发人员实现应用程序安全所花费的时间和精力。</p><br><a id="more"></a><br><br><p>Shiro能做什么呢？</p>

<ul><br>  <li>验证用户身份</li><br>  <li>用户访问权限控制，比如：1、判断用户是否分配了一定的安全角色。2、判断用户是否被授予完成某个操作的权限</li><br>  <li>在非 web 或 EJB 容器的环境下可以任意使用Session API</li><br>  <li>可以响应认证、访问控制，或者 Session 生命周期中发生的事件</li><br>  <li>可将一个或以上用户安全数据源数据组合成一个复合的用户 “view”(视图)</li><br>  <li>支持单点登录(SSO)功能</li><br>  <li>支持提供“Remember Me”服务，获取用户关联信息而无需登录<br><br>…</li><br></ul>

<p>等等——都集成到一个有凝聚力的易于使用的API。</p>

<p>Shiro 致力在所有应用环境下实现上述功能，小到命令行应用程序，大到企业应用中，而且不需要借助第三方框架、容器、应用服务器等。当然 Shiro 的目的是尽量的融入到这样的应用环境中去，但也可以在它们之外的任何环境下开箱即用。</p>

<h5 id="Apache-Shiro-Features-特性"><a href="#Apache-Shiro-Features-特性" class="headerlink" title="Apache Shiro Features 特性"></a>Apache Shiro Features 特性</h5><p>Apache Shiro是一个全面的、蕴含丰富功能的安全框架。下图为描述Shiro功能的框架图：</p>
<!-- <img src="img/ShiroFeatures.png" /> -->
<p>Authentication（认证）, Authorization（授权）, Session Management（会话管理）, Cryptography（加密）被 Shiro 框架的开发团队称之为应用安全的四大基石。那么就让我们来看看它们吧：</p>

<ul><br>  <li><strong>Authentication（认证）：</strong>用户身份识别，通常被称为用户“登录”</li><br>  <li><strong>Authorization（授权）：</strong>访问控制。比如某个用户是否具有某个操作的使用权限。</li><br>  <li><strong>Session Management（会话管理）：</strong>特定于用户的会话管理,甚至在非web 或 EJB 应用程序。</li><br>  <li><strong>Cryptography（加密）：</strong>在对数据源使用加密算法加密的同时，保证易于使用。</li><br></ul>

<p>还有其他的功能来支持和加强这些不同应用环境下安全领域的关注点。特别是对以下的功能支持：</p>

<ul><br>  <li>Web支持：Shiro 提供的 web 支持 api ，可以很轻松的保护 web 应用程序的安全。</li><br>  <li>缓存：缓存是 Apache Shiro 保证安全操作快速、高效的重要手段。</li><br>  <li>并发：Apache Shiro 支持多线程应用程序的并发特性。</li><br>  <li>测试：支持单元测试和集成测试，确保代码和预想的一样安全。</li><br>  <li>“Run As”：这个功能允许用户假设另一个用户的身份(在许可的前提下)。</li><br>  <li>“Remember Me”：跨 session 记录用户的身份，只有在强制需要时才需要登录。</li><br></ul>

<blockquote><br>  <p>注意： Shiro不会去维护用户、维护权限，这些需要我们自己去设计/提供，然后通过相应的接口注入给Shiro</p><br></blockquote>


<h5 id="High-Level-Overview-高级概述"><a href="#High-Level-Overview-高级概述" class="headerlink" title="High-Level Overview 高级概述"></a>High-Level Overview 高级概述</h5><p>在概念层，Shiro 架构包含三个主要的理念：Subject,SecurityManager和 Realm。下面的图展示了这些组件如何相互作用，我们将在下面依次对其进行描述。</p>

<!-- <img src="img/ShiroBasicArchitecture.png" /> -->
<ul><br>  <li>Subject：当前用户，Subject 可以是一个人，但也可以是第三方服务、守护进程帐户、时钟守护任务或者其它–当前和软件交互的任何事件。</li><br>  <li>SecurityManager：管理所有Subject，SecurityManager 是 Shiro 架构的核心，配合内部安全组件共同组成安全伞。</li><br>  <li>Realms：用于进行权限信息的验证，我们自己实现。Realm 本质上是一个特定的安全 DAO：它封装与数据源连接的细节，得到Shiro 所需的相关的数据。在配置 Shiro 的时候，你必须指定至少一个Realm 来实现认证（authentication）和/或授权（authorization）。</li><br></ul>

<p>我们需要实现Realms的Authentication 和 Authorization。其中 Authentication 是用来验证用户身份，Authorization 是授权访问控制，用于对用户进行的操作授权，证明该用户是否允许进行当前操作，如访问某个链接，某个资源文件等。</p>

<h5 id="快速上手"><a href="#快速上手" class="headerlink" title="快速上手"></a>快速上手</h5><h6 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sourceforge.nekohtml<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nekohtml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<h6 id="Shiro-配置"><a href="#Shiro-配置" class="headerlink" title="Shiro 配置"></a>Shiro 配置</h6><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">@Configuration</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</div><div class="line">	@Bean</div><div class="line">	<span class="keyword">public</span> ShiroFilterFactoryBean shirFilter(SecurityManager securityManager) &#123;</div><div class="line">		System.out.println(<span class="string">"ShiroConfiguration.shirFilter()"</span>);</div><div class="line">		ShiroFilterFactoryBean shiroFilterFactoryBean = <span class="keyword">new</span> <span class="type">ShiroFilterFactoryBean</span>();</div><div class="line">		shiroFilterFactoryBean.setSecurityManager(securityManager);</div><div class="line">		<span class="comment">//拦截器.</span></div><div class="line">		Map&lt;<span class="keyword">String</span>,<span class="keyword">String</span>&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="type">LinkedHashMap</span>&lt;<span class="keyword">String</span>,<span class="keyword">String</span>&gt;();</div><div class="line">		<span class="comment">// 配置不会被拦截的链接 顺序判断</span></div><div class="line">		filterChainDefinitionMap.put(<span class="string">"/static/**"</span>, <span class="string">"anon"</span>);</div><div class="line">		<span class="comment">//配置退出 过滤器,其中的具体的退出代码Shiro已经替我们实现了</span></div><div class="line">		filterChainDefinitionMap.put(<span class="string">"/logout"</span>, <span class="string">"logout"</span>);</div><div class="line">		<span class="comment">//&lt;!-- 过滤链定义，从上向下顺序执行，一般将/**放在最为下边 --&gt;:这是一个坑呢，一不小心代码就不好使了;</span></div><div class="line">		<span class="comment">//&lt;!-- authc:所有url都必须认证通过才可以访问; anon:所有url都都可以匿名访问--&gt;</span></div><div class="line">		filterChainDefinitionMap.put(<span class="string">"/**"</span>, <span class="string">"authc"</span>);</div><div class="line">		<span class="comment">// 如果不设置默认会自动寻找Web工程根目录下的"/login.jsp"页面</span></div><div class="line">		shiroFilterFactoryBean.setLoginUrl(<span class="string">"/login"</span>);</div><div class="line">		<span class="comment">// 登录成功后要跳转的链接</span></div><div class="line">		shiroFilterFactoryBean.setSuccessUrl(<span class="string">"/index"</span>);</div><div class="line"></div><div class="line">		<span class="comment">//未授权界面;</span></div><div class="line">		shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">"/403"</span>);</div><div class="line">		shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</div><div class="line">		<span class="keyword">return</span> shiroFilterFactoryBean;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Bean</div><div class="line">	<span class="keyword">public</span> MyShiroRealm myShiroRealm()&#123;</div><div class="line">		MyShiroRealm myShiroRealm = <span class="keyword">new</span> <span class="type">MyShiroRealm</span>();</div><div class="line">		<span class="keyword">return</span> myShiroRealm;</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	@Bean</div><div class="line">	<span class="keyword">public</span> SecurityManager securityManager()&#123;</div><div class="line">		DefaultWebSecurityManager securityManager =  <span class="keyword">new</span> <span class="type">DefaultWebSecurityManager</span>();</div><div class="line">		securityManager.setRealm(myShiroRealm());</div><div class="line">		<span class="keyword">return</span> securityManager;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h6 id="Filter-Chain定义说明："><a href="#Filter-Chain定义说明：" class="headerlink" title="Filter Chain定义说明："></a>Filter Chain定义说明：</h6><ul><br>  <li>1、一个URL可以配置多个Filter，使用逗号分隔</li><br>  <li>2、当设置多个过滤器时，全部验证通过，才视为通过</li><br>  <li>3、部分过滤器可指定参数，如perms，roles</li><br></ul>

<h6 id="Shiro内置的FilterChain"><a href="#Shiro内置的FilterChain" class="headerlink" title="Shiro内置的FilterChain:"></a>Shiro内置的FilterChain:</h6><table>
<thead>
<tr>
<th>Filter Name</th>
<th>Class</th>
</tr>
</thead>
<tbody>
<tr>
<td>anon</td>
<td>org.apache.shiro.web.filter.authc.AnonymousFilter</td>
</tr>
<tr>
<td>authc</td>
<td>org.apache.shiro.web.filter.authc.FormAuthenticationFilter</td>
</tr>
<tr>
<td>authcBasic</td>
<td>org.apache.shiro.web.filter.authc.BasicHttpAuthenticationFilter</td>
</tr>
<tr>
<td>perms</td>
<td>org.apache.shiro.web.filter.authz.PermissionsAuthorizationFilter</td>
</tr>
<tr>
<td>port</td>
<td>org.apache.shiro.web.filter.authz.PortFilter</td>
</tr>
<tr>
<td>rest</td>
<td>org.apache.shiro.web.filter.authz.HttpMethodPermissionFilter</td>
</tr>
<tr>
<td>roles</td>
<td>org.apache.shiro.web.filter.authz.RolesAuthorizationFilter</td>
</tr>
<tr>
<td>ssl</td>
<td>org.apache.shiro.web.filter.authz.SslFilter</td>
</tr>
<tr>
<td>user</td>
<td>org.apache.shiro.web.filter.authc.UserFilter</td>
</tr>
</tbody>
</table>
<ul><br>  <li>anon:所有url都都可以匿名访问</li><br>  <li>authc: 需要认证才能进行访问</li><br>  <li>user:配置记住我或认证通过可以访问</li><br></ul>

<p><strong>登录认证实现</strong></p>

<p>在认证、授权内部实现机制中都有提到，最终处理都将交给Real进行处理。因为在Shiro中，最终是通过Realm来获取应用程序中的用户、角色及权限信息的。通常情况下，在Realm中会直接从我们的数据源中获取Shiro需要的验证信息。可以说，Realm是专用于安全框架的DAO.<br>Shiro的认证过程最终会交由Realm执行，这时会调用Realm的<code class="highlighter-rouge">getAuthenticationInfo(token)</code>方法。</p>

<p>该方法主要执行以下操作:</p>

<ul><br>  <li>1、检查提交的进行认证的令牌信息</li><br>  <li>2、根据令牌信息从数据源(通常为数据库)中获取用户信息</li><br>  <li>3、对用户信息进行匹配验证。</li><br>  <li>4、验证通过将返回一个封装了用户信息的<code class="highlighter-rouge">AuthenticationInfo</code>实例。</li><br>  <li>5、验证失败则抛出<code class="highlighter-rouge">AuthenticationException</code>异常信息。</li><br></ul>

<p>而在我们的应用程序中要做的就是自定义一个Realm类，继承AuthorizingRealm抽象类，重载doGetAuthenticationInfo()，重写获取用户信息的方法。</p>

<p>doGetAuthenticationInfo的重写</p>

<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line"><span class="keyword">protected</span> AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token)</div><div class="line">        <span class="keyword">throws</span> AuthenticationException &#123;</div><div class="line">    System.out.<span class="built_in">println</span>(<span class="string">"MyShiroRealm.doGetAuthenticationInfo()"</span>);</div><div class="line">    <span class="comment">//获取用户的输入的账号.</span></div><div class="line">    <span class="keyword">String</span> username = (<span class="keyword">String</span>)token.getPrincipal();</div><div class="line">    System.out.<span class="built_in">println</span>(token.getCredentials());</div><div class="line">    <span class="comment">//通过username从数据库中查找 User对象，如果找到，没找到.</span></div><div class="line">    <span class="comment">//实际项目中，这里可以根据实际情况做缓存，如果不做，Shiro自己也是有时间间隔机制，2分钟内不会重复执行该方法</span></div><div class="line">    UserInfo userInfo = userInfoService.findByUsername(username);</div><div class="line">    System.out.<span class="built_in">println</span>(<span class="string">"-----&gt;&gt;userInfo="</span>+userInfo);</div><div class="line">    <span class="keyword">if</span>(userInfo == <span class="keyword">null</span>)&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    SimpleAuthenticationInfo authenticationInfo = <span class="keyword">new</span> SimpleAuthenticationInfo(</div><div class="line">            userInfo, <span class="comment">//用户名</span></div><div class="line">            userInfo.getPassword(), <span class="comment">//密码</span></div><div class="line">            ByteSource.Util.bytes(userInfo.getCredentialsSalt()),<span class="comment">//salt=username+salt</span></div><div class="line">            getName()  <span class="comment">//realm name</span></div><div class="line">    );</div><div class="line">    <span class="keyword">return</span> authenticationInfo;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>链接权限的实现</strong></p>

<p>shiro的权限授权是通过继承<code class="highlighter-rouge">AuthorizingRealm</code>抽象类，重载<code class="highlighter-rouge">doGetAuthorizationInfo();</code>当访问到页面的时候，链接配置了相应的权限或者shiro标签才会执行此方法否则不会执行，所以如果只是简单的身份认证没有权限的控制的话，那么这个方法可以不进行实现，直接返回null即可。在这个方法中主要是使用类：<code class="highlighter-rouge">SimpleAuthorizationInfo</code>进行角色的添加和权限的添加。</p>

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">protected</span> AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) &#123;</div><div class="line">    System.out.println(<span class="string">"权限配置--&gt;MyShiroRealm.doGetAuthorizationInfo()"</span>);</div><div class="line">    SimpleAuthorizationInfo authorizationInfo = <span class="keyword">new</span> SimpleAuthorizationInfo();</div><div class="line">    UserInfo userInfo  = (UserInfo)principals.getPrimaryPrincipal();</div><div class="line">    <span class="keyword">for</span>(SysRole <span class="string">role:</span>userInfo.getRoleList())&#123;</div><div class="line">        authorizationInfo.addRole(role.getRole());</div><div class="line">        <span class="keyword">for</span>(SysPermission <span class="string">p:</span>role.getPermissions())&#123;</div><div class="line">            authorizationInfo.addStringPermission(p.getPermission());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> authorizationInfo;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然也可以添加set集合：roles是从数据库查询的当前用户的角色，stringPermissions是从数据库查询的当前用户对应的权限</p>

<figure class="highlight abnf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">authorizationInfo.setRoles(roles)<span class="comment">;</span></div><div class="line">authorizationInfo.setStringPermissions(stringPermissions)<span class="comment">;</span></div></pre></td></tr></table></figure>
<p>就是说如果在shiro配置文件中添加了<code class="highlighter-rouge">filterChainDefinitionMap.put(“/add”, “perms[权限添加]”);</code>就说明访问/add这个链接必须要有“权限添加”这个权限才可以访问，如果在shiro配置文件中添加了<code class="highlighter-rouge">filterChainDefinitionMap.put(“/add”, “roles[100002]，perms[权限添加]”);</code>就说明访问<code class="highlighter-rouge">/add</code>这个链接必须要有“权限添加”这个权限和具有“100002”这个角色才可以访问。</p>

<p><strong>参考附录:</strong></p><br><p><a href="https://waylau.gitbooks.io/apache-shiro-1-2-x-reference/content/" target="_blank" rel="external">Apache Shiro中文手册</a> <br><br><a href="http://412887952-qq-com.iteye.com/blog/2299777" target="_blank" rel="external">Spring Boot Shiro权限管理【从零开始学Spring Boot】</a><br><br><a href="http://z77z.oschina.io/2017/02/13/SpringBoot+shiro%E6%95%B4%E5%90%88%E5%AD%A6%E4%B9%A0%E4%B9%8B%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81%E5%92%8C%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6/" target="_blank" rel="external">SpringBoot+shiro整合学习之登录认证和权限控制</a> <br><br><a href="http://www.ityouknow.com/springboot/2017/06/26/springboot-shiro.html" target="_blank" rel="external">springboot整合shiro-登录认证和权限管理</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h5 id=&quot;What-is-Apache-Shiro&quot;&gt;&lt;a href=&quot;#What-is-Apache-Shiro&quot; class=&quot;headerlink&quot; title=&quot;What is Apache Shiro?&quot;&gt;&lt;/a&gt;What is Apache Shiro?&lt;/h5&gt;&lt;p&gt;Apache Shiro是一个功能强大、灵活的，开源的安全框架。它可以干净利落地处理身份验证、授权、企业会话管理和加密。&lt;/p&gt;

&lt;p&gt;Apache Shiro的首要目标是易于使用和理解。安全通常很复杂，甚至让人感到很痛苦，但是Shiro却不是这样子的。一个好的安全框架应该屏蔽复杂性，向外暴露简单、直观的API，来简化开发人员实现应用程序安全所花费的时间和精力。&lt;/p&gt;&lt;br&gt;
    
    </summary>
    
      <category term="spring" scheme="http://yoursite.com/categories/spring/"/>
    
    
      <category term="spring" scheme="http://yoursite.com/tags/spring/"/>
    
      <category term="shiro" scheme="http://yoursite.com/tags/shiro/"/>
    
  </entry>
  
  <entry>
    <title>ThreadLocal</title>
    <link href="http://yoursite.com/2017/07/22/thread-local/"/>
    <id>http://yoursite.com/2017/07/22/thread-local/</id>
    <published>2017-07-22T10:54:25.000Z</published>
    <updated>2017-08-07T15:53:39.847Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ThreadLocal用法"><a href="#ThreadLocal用法" class="headerlink" title="ThreadLocal用法"></a>ThreadLocal用法</h3><p>Java中线程的同步机制保证了多线程访问共享变量的安全性，通常我们使用synchronized关键字来实现。在多个线程对共享变量进行读写操作时，同步锁保证了同一时间只有一个线程对共享变量进行操作，概括地说，这是一种“以时间换空间”的解决策略。</p>
<p>在JDK1.2中引入了ThreadLocal类来提供了一种“以空间换时间”的同步解决策略。ThreadLocal内部维护了一份类似Map的静态变量ThreadLocalMap，其中key为当前线程，value为共享变量。JDK1.5引入泛型，ThreadLocal也同时支持泛型。<br><a id="more"></a><br>其具体实现如下<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocal</span>&lt;T&gt; &#123;</span></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * ThreadLocals rely on per-thread hash maps attached to each thread</div><div class="line">   * (Thread.threadLocals and inheritableThreadLocals).  The ThreadLocal</div><div class="line">   * objects act as keys, searched via threadLocalHashCode.  This is a</div><div class="line">   * custom hash code (useful only within ThreadLocalMaps) that eliminates</div><div class="line">   * collisions in the common case where consecutively constructed</div><div class="line">   * ThreadLocals are used by the same threads, while remaining well-behaved</div><div class="line">   * in less common cases.</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> final <span class="keyword">int</span> threadLocalHashCode = nextHashCode();</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * The next hash code to be given out. Accessed only by like-named method.</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> nextHashCode = <span class="number">0</span>;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * The difference between successively generated hash codes - turns</div><div class="line">   * implicit sequential thread-local IDs into near-optimally spread</div><div class="line">   * multiplicative hash values for power-of-two-sized tables.</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> final <span class="keyword">int</span> HASH_INCREMENT = <span class="number">0x61c88647</span>;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Compute the next hash code. The static synchronization used here</div><div class="line">   * should not be a performance bottleneck. When ThreadLocals are</div><div class="line">   * generated in different threads at a fast enough rate to regularly</div><div class="line">   * contend on this lock, memory contention is by far a more serious</div><div class="line">   * problem than lock contention.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> synchronized <span class="keyword">int</span> <span class="title">nextHashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">int</span> h = nextHashCode;</div><div class="line">      nextHashCode = h + HASH_INCREMENT;</div><div class="line">      <span class="keyword">return</span> h;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Creates a thread local variable.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ThreadLocal</span><span class="params">()</span> </span>&#123;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Returns the value in the current thread's copy of this thread-local</div><div class="line">   * variable.  Creates and initializes the copy if this is the first time</div><div class="line">   * the thread has called this method.</div><div class="line">   *</div><div class="line">   * @return the current thread's value of this thread-local</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">      Thread t = Thread.currentThread();</div><div class="line">      ThreadLocalMap <span class="built_in">map</span> = getMap(t);</div><div class="line">      <span class="keyword">if</span> (<span class="built_in">map</span> != null)</div><div class="line">          <span class="keyword">return</span> (T)<span class="built_in">map</span>.get(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">      <span class="comment">// Maps are constructed lazily.  if the map for this thread</span></div><div class="line">      <span class="comment">// doesn't exist, create it, with this ThreadLocal and its</span></div><div class="line">      <span class="comment">// initial value as its only entry.</span></div><div class="line">      T value = initialValue();</div><div class="line">      createMap(t, value);</div><div class="line">      <span class="keyword">return</span> value;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Sets the current thread's copy of this thread-local variable</div><div class="line">   * to the specified value.  Many applications will have no need for</div><div class="line">   * this functionality, relying solely on the &#123;@link #initialValue&#125;</div><div class="line">   * method to set the values of thread-locals.</div><div class="line">   *</div><div class="line">   * @param value the value to be stored in the current threads' copy of</div><div class="line">   *        this thread-local.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</div><div class="line">      Thread t = Thread.currentThread();</div><div class="line">      ThreadLocalMap <span class="built_in">map</span> = getMap(t);</div><div class="line">      <span class="keyword">if</span> (<span class="built_in">map</span> != null)</div><div class="line">          <span class="built_in">map</span>.<span class="built_in">set</span>(<span class="keyword">this</span>, value);</div><div class="line">      <span class="keyword">else</span></div><div class="line">          createMap(t, value);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Get the map associated with a ThreadLocal. Overridden in</div><div class="line">   * InheritableThreadLocal.</div><div class="line">   *</div><div class="line">   * @param  t the current thread</div><div class="line">   * @return the map</div><div class="line">   */</div><div class="line">  <span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> t.threadLocals;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Create the map associated with a ThreadLocal. Overridden in</div><div class="line">   * InheritableThreadLocal.</div><div class="line">   *</div><div class="line">   * @param t the current thread</div><div class="line">   * @param firstValue value for the initial entry of the map</div><div class="line">   * @param map the map to store.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">createMap</span><span class="params">(Thread t, T firstValue)</span> </span>&#123;</div><div class="line">      t.threadLocals = <span class="keyword">new</span> ThreadLocalMap(<span class="keyword">this</span>, firstValue);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  .......</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * ThreadLocalMap is a customized hash map suitable only for</div><div class="line">   * maintaining thread local values. No operations are exported</div><div class="line">   * outside of the ThreadLocal class. The class is package private to</div><div class="line">   * allow declaration of fields in class Thread.  To help deal with</div><div class="line">   * very large and long-lived usages, the hash table entries use</div><div class="line">   * WeakReferences for keys. However, since reference queues are not</div><div class="line">   * used, stale entries are guaranteed to be removed only when</div><div class="line">   * the table starts running out of space.</div><div class="line">   */</div><div class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalMap</span> &#123;</span></div><div class="line"></div><div class="line">  ........</div><div class="line"></div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从中很清晰的可以看出，多个线程拥有自己一份单独的ThreadLocalMap，共享变量对于每个线程都是单独的一份，因此不会造成线程的安全问题。</p>
<p>JDBC的ConnectionManager类就是以这种方式来实现数据库连接Connection对象线程隔离。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">import java.sql.Connection;</div><div class="line">import java.sql.DriverManager;</div><div class="line">import java.sql.SQLException;</div><div class="line"></div><div class="line">public class ConnectionManager &#123;</div><div class="line"></div><div class="line">	private static ThreadLocal&lt;Connection&gt; connectionHolder = new ThreadLocal&lt;Connection&gt;() &#123;</div><div class="line">		@Override</div><div class="line">		protected<span class="built_in"> Connection </span>initialValue() &#123;</div><div class="line">		<span class="built_in">	Connection </span>conn = <span class="literal">null</span>;</div><div class="line">			try &#123;</div><div class="line">				conn = DriverManager.getConnection(</div><div class="line">						<span class="string">"jdbc:mysql://localhost:3306/test"</span>, <span class="string">"username"</span>,</div><div class="line">						<span class="string">"password"</span>);</div><div class="line">			&#125; catch (SQLException e) &#123;</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">			return conn;</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line"></div><div class="line">	public static<span class="built_in"> Connection </span>getConnection() &#123;</div><div class="line">		return connectionHolder.<span class="builtin-name">get</span>();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public static void setConnection(Connection conn) &#123;</div><div class="line">		connectionHolder.<span class="builtin-name">set</span>(conn);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但是，有些情况ThreadLocal可能并不适用，例如存储大量数据的共享变量，或共享变量只能被创建一次时，就只能通过synchronized来实现了。</p>
<p><a href="https://my.oschina.net/lichhao/blog/111362" target="_blank" rel="external">推荐阅读</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;ThreadLocal用法&quot;&gt;&lt;a href=&quot;#ThreadLocal用法&quot; class=&quot;headerlink&quot; title=&quot;ThreadLocal用法&quot;&gt;&lt;/a&gt;ThreadLocal用法&lt;/h3&gt;&lt;p&gt;Java中线程的同步机制保证了多线程访问共享变量的安全性，通常我们使用synchronized关键字来实现。在多个线程对共享变量进行读写操作时，同步锁保证了同一时间只有一个线程对共享变量进行操作，概括地说，这是一种“以时间换空间”的解决策略。&lt;/p&gt;
&lt;p&gt;在JDK1.2中引入了ThreadLocal类来提供了一种“以空间换时间”的同步解决策略。ThreadLocal内部维护了一份类似Map的静态变量ThreadLocalMap，其中key为当前线程，value为共享变量。JDK1.5引入泛型，ThreadLocal也同时支持泛型。&lt;br&gt;
    
    </summary>
    
      <category term="JAVA" scheme="http://yoursite.com/categories/JAVA/"/>
    
    
      <category term="JAVA" scheme="http://yoursite.com/tags/JAVA/"/>
    
  </entry>
  
  <entry>
    <title>Spring-cloud入门介绍</title>
    <link href="http://yoursite.com/2017/07/22/spring-introduction/"/>
    <id>http://yoursite.com/2017/07/22/spring-introduction/</id>
    <published>2017-07-22T10:52:56.000Z</published>
    <updated>2017-08-07T15:53:31.568Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Spring-cloud入门介绍"><a href="#Spring-cloud入门介绍" class="headerlink" title="Spring-cloud入门介绍"></a>Spring-cloud入门介绍</h3><p><a href="https://projects.spring.io/spring-cloud/" target="_blank" rel="external">Spring Cloud官网</a></p>
<p><a href="https://springcloud.cc/" target="_blank" rel="external">Spring Cloud中文网</a></p>
<h4 id="一、Spring-Cloud-Netflix"><a href="#一、Spring-Cloud-Netflix" class="headerlink" title="一、Spring Cloud Netflix"></a>一、Spring Cloud Netflix</h4><h4 id="二、服务提供与调用"><a href="#二、服务提供与调用" class="headerlink" title="二、服务提供与调用"></a>二、服务提供与调用</h4><a id="more"></a>
<h4 id="三、熔断器Hystrix"><a href="#三、熔断器Hystrix" class="headerlink" title="三、熔断器Hystrix"></a>三、熔断器Hystrix</h4><h4 id="四、熔断监控Hystrix-Dashboard和Turbine"><a href="#四、熔断监控Hystrix-Dashboard和Turbine" class="headerlink" title="四、熔断监控Hystrix Dashboard和Turbine"></a>四、熔断监控Hystrix Dashboard和Turbine</h4><h4 id="五、配置中心git示例"><a href="#五、配置中心git示例" class="headerlink" title="五、配置中心git示例"></a>五、配置中心git示例</h4>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Spring-cloud入门介绍&quot;&gt;&lt;a href=&quot;#Spring-cloud入门介绍&quot; class=&quot;headerlink&quot; title=&quot;Spring-cloud入门介绍&quot;&gt;&lt;/a&gt;Spring-cloud入门介绍&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://projects.spring.io/spring-cloud/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Spring Cloud官网&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://springcloud.cc/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Spring Cloud中文网&lt;/a&gt;&lt;/p&gt;
&lt;h4 id=&quot;一、Spring-Cloud-Netflix&quot;&gt;&lt;a href=&quot;#一、Spring-Cloud-Netflix&quot; class=&quot;headerlink&quot; title=&quot;一、Spring Cloud Netflix&quot;&gt;&lt;/a&gt;一、Spring Cloud Netflix&lt;/h4&gt;&lt;h4 id=&quot;二、服务提供与调用&quot;&gt;&lt;a href=&quot;#二、服务提供与调用&quot; class=&quot;headerlink&quot; title=&quot;二、服务提供与调用&quot;&gt;&lt;/a&gt;二、服务提供与调用&lt;/h4&gt;
    
    </summary>
    
      <category term="spring-cloud" scheme="http://yoursite.com/categories/spring-cloud/"/>
    
    
      <category term="spring" scheme="http://yoursite.com/tags/spring/"/>
    
      <category term="spring-cloud" scheme="http://yoursite.com/tags/spring-cloud/"/>
    
  </entry>
  
  <entry>
    <title>第一篇博客</title>
    <link href="http://yoursite.com/2017/07/16/My-first-post/"/>
    <id>http://yoursite.com/2017/07/16/My-first-post/</id>
    <published>2017-07-16T03:17:11.000Z</published>
    <updated>2017-08-07T15:53:35.496Z</updated>
    
    <content type="html"><![CDATA[<h3 id="为什么我要开始要写博客"><a href="#为什么我要开始要写博客" class="headerlink" title="为什么我要开始要写博客"></a>为什么我要开始要写博客</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;从15年11月份以来，这一年多在企业工作的日子里，我收获许多。作为一个渴望学技术的程序员，我慢慢摆脱了学校的那种安逸的生活，开始走上了技术宅的道路。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;在企业中，前几个月的时间里，我每天都像是海绵一样吸收着养分，学习企业的架构，项目的开发，部署，优化以及维护工作。我每天都痛苦并快乐着，虽然加班，但是我能感觉到自己一点一点的在往上爬。我学会SpringMVC架构，学会使用Maven构建项目，用Ant来实现自动部署项目，用Groovy脚本来编写告警任务。学会了很多软件，诸如MongoDB，Redis等常用开发软件。这个过程中，我很快乐，并且每天都在进步。<br><a id="more"></a><br>&nbsp;&nbsp;&nbsp;&nbsp;但是到了17年的3,4月份，我熟悉了团队的各种业务，也明白了项目中所用到的框架和各种技术。我每天做的除了日常的开发和维护，似乎陷入了重复造轮子的困境。虽然在这过程中，我学会了怎样去考虑到新业务或新场景的设计流程和后续的维护过程，但是我始终感觉到了自己的进步慢慢的缓下了，这是我不希望看到的，我渴望进步和成功。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;最终，我看到了一句话，“种一棵树，最好的时间是十年前，其次，是现在”，我开始领悟到我必须改变点什么。我开始看基础的JAVA进阶等书籍，开始每天看技术博客或推文，培养自己的兴趣，并且从现在开始，写博客。我以前似乎总在犹豫，我常常害怕自己的技术不够好，但是，从另外一个方面想，这又有什么关系，那就学吧。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;为什么写博客，因为它是对你看到，用到知识的升华。在写博客的过程中，不仅会让你review以前的代码，考虑更好的设计方案，也会让你对知识的理解更上一层楼，并记忆深刻。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;写代码的时候，往往避免不了遇到各种BUG和技术难点，但是没关系，多请教别人，大多数人愿意和你分享自己的所得。和优秀的人多交流，你们会相互收益。最后，最重要的是，告诉自己不要怕，并且时刻保持一个谦卑的心。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;为什么我要开始要写博客&quot;&gt;&lt;a href=&quot;#为什么我要开始要写博客&quot; class=&quot;headerlink&quot; title=&quot;为什么我要开始要写博客&quot;&gt;&lt;/a&gt;为什么我要开始要写博客&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;从15年11月份以来，这一年多在企业工作的日子里，我收获许多。作为一个渴望学技术的程序员，我慢慢摆脱了学校的那种安逸的生活，开始走上了技术宅的道路。&lt;/p&gt;
&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;在企业中，前几个月的时间里，我每天都像是海绵一样吸收着养分，学习企业的架构，项目的开发，部署，优化以及维护工作。我每天都痛苦并快乐着，虽然加班，但是我能感觉到自己一点一点的在往上爬。我学会SpringMVC架构，学会使用Maven构建项目，用Ant来实现自动部署项目，用Groovy脚本来编写告警任务。学会了很多软件，诸如MongoDB，Redis等常用开发软件。这个过程中，我很快乐，并且每天都在进步。&lt;br&gt;
    
    </summary>
    
      <category term="随笔" scheme="http://yoursite.com/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
      <category term="随笔" scheme="http://yoursite.com/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
</feed>
